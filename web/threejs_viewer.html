<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Molecule Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            z-index: 1000;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #87CEEB;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff6b6b;
            display: none;
            z-index: 1000;
        }
        #info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 13px;
            max-width: 250px;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="loading">
            <div class="loading-spinner"></div>
            <p>3Dモデルを読み込み中...</p>
        </div>
        <div id="error">
            <p>3Dモデルの読み込みに失敗しました</p>
        </div>
    </div>

    <!-- Three.js ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls, model;
        let moleculeName = 'Unknown Molecule';
        let frameCount = 0;
        let lastGCTime = Date.now();
        const GC_INTERVAL = 30000; // 30秒ごとにガベージコレクション

        // URLパラメータから分子情報を取得
        const urlParams = new URLSearchParams(window.location.search);
        const glbUrl = urlParams.get('glbUrl');
        moleculeName = urlParams.get('moleculeName') || moleculeName;

        function init() {
            // シーンの作成
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf5f5f5);

            // カメラの作成
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 5);

            // レンダラーの作成（品質とパフォーマンスのバランス）
            renderer = new THREE.WebGLRenderer({
                antialias: true, // アンチエイリアシング有効で滑らかに
                alpha: false, // アルファチャンネル無効でパフォーマンス維持
                powerPreference: "high-performance",
                precision: "mediump", // 中程度の精度で品質向上
                stencil: false, // ステンシルバッファ無効
                depth: true, // デプスバッファは必要
                preserveDrawingBuffer: false // フレームバッファ保持無効
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = false; // 影を無効
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5)); // ピクセル比を少し上げる

            // 追加のパフォーマンス設定
            renderer.info.autoReset = false; // レンダリング統計のリセット無効
            renderer.sortObjects = false; // オブジェクトソート無効でパフォーマンス向上

            document.getElementById('container').appendChild(renderer.domElement);

            // コントロールの設定（最大パフォーマンス重視）
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = false; // ダンピング無効でパフォーマンス向上
            controls.enablePan = false; // パン無効
            controls.enableZoom = true; // ズームのみ有効
            controls.enableRotate = true; // 回転のみ有効
            controls.screenSpacePanning = false;
            controls.minDistance = 0.5;
            controls.maxDistance = 20; // 最大距離をさらに制限
            controls.autoRotate = false;
            controls.rotateSpeed = 0.5; // 回転速度を下げる
            controls.zoomSpeed = 0.5; // ズーム速度を下げる

            // ライティングの設定
            setupLighting();

            // ウィンドウリサイズ対応
            window.addEventListener('resize', onWindowResize, false);
        }

        function setupLighting() {
            // バランスの取れたライティング
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7); // 環境光を少し下げる
            scene.add(ambientLight);

            // 軽量な方向光を1つだけ追加（立体感を向上）
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.3);
            directionalLight.position.set(2, 2, 2);
            directionalLight.castShadow = false; // 影は無効
            scene.add(directionalLight);
        }

        function loadModel(url) {
            const loader = new THREE.GLTFLoader();

            loader.load(
                url,
                function (gltf) {
                    model = gltf.scene;

                    // モデルのスケールと位置を調整
                    const box = new THREE.Box3().setFromObject(model);
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    // モデルを中央に配置
                    model.position.sub(center);

                    // サイズを正規化（初期表示を大きくするために拡大率を増加）
                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 8 / maxDim; // 6から8に変更してより大きく表示
                    model.scale.setScalar(scale);

                    // マテリアルの設定と色調整（パフォーマンス最適化）
                    model.traverse((child) => {
                        if (child.isMesh) {
                            child.castShadow = false; // 影を無効でパフォーマンス向上
                            child.receiveShadow = false;
                            child.frustumCulled = true; // フラスタムカリング有効

                            // マテリアルの改善と色の調整（最大パフォーマンス重視）
                            if (child.material) {
                                // 元の色を保存
                                const originalColor = child.material.color ? child.material.color.clone() : new THREE.Color(0xffffff);

                                // BasicMaterialに置き換えてGPU負荷を大幅削減
                                child.material = new THREE.MeshBasicMaterial({
                                    color: originalColor,
                                    transparent: false,
                                    fog: false,
                                    vertexColors: false
                                });
                                child.material.needsUpdate = false; // 更新処理を無効

                                // 原子の色を識別してUI色分けと合わせる（より濃い色調）
                                const materialColor = child.material.color;
                                if (materialColor) {
                                    console.log('Original atom color:', materialColor.r.toFixed(3), materialColor.g.toFixed(3), materialColor.b.toFixed(3));

                                    // 炭素（より濃いグレー）- 暗い色全般
                                    if (materialColor.r < 0.4 && materialColor.g < 0.4 && materialColor.b < 0.4) {
                                        materialColor.setHex(0x404040);
                                        console.log('Detected Carbon');
                                    }
                                    // 酸素（濃い赤色）- 赤っぽい色
                                    else if (materialColor.r > 0.6 && materialColor.g < 0.5 && materialColor.b < 0.5) {
                                        materialColor.setHex(0xD32F2F);
                                        console.log('Detected Oxygen');
                                    }
                                    // 窒素（濃い青色）- 青っぽい色
                                    else if (materialColor.r < 0.5 && materialColor.g < 0.6 && materialColor.b > 0.6) {
                                        materialColor.setHex(0x1976D2);
                                        console.log('Detected Nitrogen');
                                    }
                                    // 水素（濃いグレー）- 明るいグレー/白っぽい色
                                    else if (materialColor.r > 0.7 && materialColor.g > 0.7 && materialColor.b > 0.7 &&
                                             Math.abs(materialColor.r - materialColor.g) < 0.15 && Math.abs(materialColor.g - materialColor.b) < 0.15) {
                                        materialColor.setHex(0xD0D0D0);
                                        console.log('Detected Hydrogen');
                                    }
                                    // マグネシウム（緑色）- クロロフィル特有の厳密条件
                                    else if (materialColor.r < 0.6 && materialColor.g > 0.7 && materialColor.b < 0.6 &&
                                             materialColor.g > materialColor.r * 1.3 && materialColor.g > materialColor.b * 1.2) {
                                        materialColor.setHex(0x388E3C); // 濃い緑色（マグネシウム）
                                        console.log('Detected Magnesium');
                                    }
                                    // 硫黄（濃い黄色）- 黄色系
                                    else if (materialColor.r > 0.7 && materialColor.g > 0.7 && materialColor.b < 0.5) {
                                        materialColor.setHex(0xF9A825);
                                        console.log('Detected Sulfur');
                                    }
                                    // リン（濃いオレンジ）- オレンジ系
                                    else if (materialColor.r > 0.8 && materialColor.g > 0.4 && materialColor.g < 0.7 && materialColor.b < 0.4) {
                                        materialColor.setHex(0xFF6F00);
                                        console.log('Detected Phosphorus');
                                    }
                                    // 塩素（濃い緑色）- 純粋な緑色系
                                    else if (materialColor.r < 0.4 && materialColor.g > 0.6 && materialColor.b < 0.4 &&
                                             materialColor.g > materialColor.r * 1.8 && materialColor.g > materialColor.b * 1.8) {
                                        materialColor.setHex(0x43A047);
                                        console.log('Detected Chlorine');
                                    }
                                    // 鉄（茶色）- 茶色系
                                    else if (materialColor.r > 0.5 && materialColor.g > 0.3 && materialColor.g < materialColor.r && materialColor.b < 0.4) {
                                        materialColor.setHex(0x8D6E63);
                                        console.log('Detected Iron');
                                    }
                                    // カリウム（濃い紫色）- 紫系
                                    else if (materialColor.r > 0.5 && materialColor.g < 0.4 && materialColor.b > 0.6 && materialColor.b > materialColor.r) {
                                        materialColor.setHex(0x7B1FA2);
                                        console.log('Detected Potassium');
                                    }
                                    // ナトリウム（濃い青紫色）- 青紫系
                                    else if (materialColor.r < 0.5 && materialColor.g < 0.5 && materialColor.b > 0.6 && materialColor.b > materialColor.r && materialColor.b > materialColor.g) {
                                        materialColor.setHex(0x303F9F);
                                        console.log('Detected Sodium');
                                    }
                                    // カルシウム（グレー）- 中程度のグレー
                                    else if (materialColor.r > 0.5 && materialColor.r < 0.8 && materialColor.g > 0.5 && materialColor.g < 0.8 && materialColor.b > 0.5 && materialColor.b < 0.8 &&
                                             Math.abs(materialColor.r - materialColor.g) < 0.1 && Math.abs(materialColor.g - materialColor.b) < 0.1) {
                                        materialColor.setHex(0xBDBDBD);
                                        console.log('Detected Calcium');
                                    }
                                }
                            }
                        }
                    });

                    scene.add(model);

                    // カメラ位置を調整（初期表示用に近づける）
                    const distance = Math.max(2.0, maxDim * scale * 0.8); // より近づける
                    camera.position.set(distance, distance * 0.5, distance);
                    controls.target.copy(model.position);
                    controls.update();

                    // ローディング画面を非表示
                    document.getElementById('loading').style.display = 'none';

                    console.log('3D model loaded successfully');
                },
                function (progress) {
                    console.log('Loading progress:', (progress.loaded / progress.total * 100) + '%');
                },
                function (error) {
                    console.error('Error loading 3D model:', error);
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                }
            );
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate() {
            requestAnimationFrame(animate);

            // 中程度のフレームレート制限（45fps）で品質とパフォーマンスのバランス
            frameCount++;
            if (frameCount % 4 < 3) return; // 4フレームに3回レンダリング（約45fps）

            controls.update();
            renderer.render(scene, camera);

            // より頻繁なメモリクリーンアップ（15秒間隔）
            const now = Date.now();
            if (now - lastGCTime > 15000) {
                if (window.gc) {
                    window.gc();
                }
                // レンダリング統計をリセット
                renderer.info.reset();
                lastGCTime = now;
                console.log('Aggressive memory cleanup performed');
            }
        }

        // ページがアンロードされるときのクリーンアップ
        window.addEventListener('beforeunload', function() {
            if (renderer) {
                renderer.dispose();
            }
            if (scene) {
                scene.traverse((child) => {
                    if (child.geometry) child.geometry.dispose();
                    if (child.material) {
                        if (child.material.map) child.material.map.dispose();
                        child.material.dispose();
                    }
                });
            }
        });

        // 初期化とモデル読み込み
        init();

        if (glbUrl) {
            loadModel(glbUrl);
        } else {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.querySelector('#error p').textContent = 'GLBファイルのURLが指定されていません';
        }

        animate();

        // Flutter からのメッセージを受信
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'loadModel') {
                if (model) {
                    scene.remove(model);
                }
                moleculeName = event.data.moleculeName || 'Unknown Molecule';
                loadModel(event.data.glbUrl);
            }
        });
    </script>
</body>
</html>